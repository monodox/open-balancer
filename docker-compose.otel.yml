# Docker Compose configuration for OpenTelemetry Collector with Datadog
# This sets up the collector as a sidecar service for open-Balancer

version: '3.8'

services:
  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: open-balancer-otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      # OTLP gRPC receiver
      - "4317:4317"
      # OTLP HTTP receiver
      - "4318:4318"
      # Health check endpoint
      - "13133:13133"
      # Metrics endpoint
      - "8888:8888"
      # pprof endpoint
      - "1777:1777"
      # zPages endpoint
      - "55679:55679"
    environment:
      # Datadog configuration
      - DD_API_KEY=${DD_API_KEY}
      - HOSTNAME=${HOSTNAME:-open-balancer-collector}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - VERSION=${VERSION:-1.0.0}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:13133/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - open-balancer-network

  # open-Balancer application
  open-balancer:
    build: .
    container_name: open-balancer-app
    ports:
      - "3000:3000"
    environment:
      # OpenTelemetry configuration
      - OTEL_SERVICE_NAME=open-balancer-frontend
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_EXPORTER_OTLP_HEADERS=
      - OTEL_RESOURCE_ATTRIBUTES=service.name=open-balancer,service.version=${VERSION:-1.0.0},deployment.environment=${ENVIRONMENT:-production}
      
      # Datadog configuration
      - DD_API_KEY=${DD_API_KEY}
      - DD_SITE=${DD_SITE:-datadoghq.com}
      
      # Application configuration
      - NODE_ENV=${NODE_ENV:-production}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      
      # Google Cloud configuration
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    depends_on:
      otel-collector:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - open-balancer-network

networks:
  open-balancer-network:
    driver: bridge

# Health check for the entire stack
# Run: docker-compose -f docker-compose.otel.yml ps
# All services should show "Up (healthy)" status